---
import "easymde/dist/easymde.min.css";
import Layout from "@/layouts/Layout.astro";
import { getCurrentUserProfile, getMediaByID } from "@/lib/supabaseServer";
import { profilePicture } from "@/lib/clientShorthand";

const sessionProfile = await getCurrentUserProfile(Astro);

const media = await getMediaByID(Astro.params.id);

if (!sessionProfile || sessionProfile.id !== media.author.id)
  return Astro.redirect("/403");
if (!media) return Astro.redirect("/404");
---

<Layout title="deletar mídia" id="deletar_midia" profile={sessionProfile}>
  <h1>Deletando mídia</h1>
  <form>
    <input type="hidden" name="id" value={media.id} />

    <h1>Você tem CERTEZA MESMO que quer deletar {media.title}??</h1>
    <p>
      Quero que pense bem noq está fazendo, a não ser q vc tenha o link do
      imgur, recuperar essa porra será literalmente impossível pra mim.
    </p>
    <img
      src={profilePicture(media.image_url)}
      alt={media.title}
      width="200"
      height="200"
    />

    <button type="submit">SIM, DELETAR!!!</button>
  </form>
</Layout>

<script>
  const form = document.querySelector("#deletar_midia form") as HTMLFormElement;

  form.addEventListener("submit", (event) => {
    event.preventDefault();
    onSubmit();
  });

  async function onSubmit() {
    const data = new FormData(form);

    const response = await (
      await fetch("/admin/actions/media", {
        method: "delete",
        body: data,
      })
    ).json();

    if (response.error) {
      alert(response.error.message);
      return;
    }

    window.location.href = `/media`;
  }
</script>
